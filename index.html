<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>演示：使用HTML5实现刮刮卡效果</title>
    <style type="text/css">
        *{
            margin:0;
            padding:0;
        }
        html,body{
            height: 100%;
        }
        .oprArea{
            height: 100%;
        }
        .bodyArea{
            height: 90%;
            position: relative;
            background: url("img/lucky-draw.png") left center no-repeat;
            background-size: contain;
        }
        .headerArea{
            height: 10%;
            background: url("img/lucky-draw.png") center center no-repeat;
            background-size: contain;
        }
        .pumpkin{
            position: absolute;
            z-index: 5;
            width: 20px;
            height: 20px;
        }
        .light{
            position: absolute;
            z-index: 10;
            pointer-events: none;
            left: 50%;
            top: 50%;
        }
        #canvas{
            display: none;
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            z-index: 8;
        }
        .allLight{
            position: absolute;
            right: 10px;
            top: 10px;
            z-index: 20;

        }
    </style>
</head>

<body>
<div class="oprArea">
    <div class="headerArea">
        <div class="cutTime">15</div>
        <div class="allLight">点亮</div>
    </div>
    <div class="bodyArea">
        <img class="light" src="img/share.png" alt="">
        <img class="pumpkin pumpkin1" src="img/star.png">
        <img class="pumpkin pumpkin2" src="img/star.png">
        <img class="pumpkin pumpkin3" src="img/star.png">
        <img class="pumpkin pumpkin4" src="img/star.png">
    </div>
</div>
<canvas id="canvas"></canvas>


<script src="jquery.js"></script>
<script type="text/javascript">
    /*    var pumpkinLight = {
     _init:function () {

     },
     _render:function () {

     },
     _bind:function () {

     }
     };*/

    window.onload = function() {
        var $pumpkin = $('.pumpkin');
        var canvas = document.querySelector('canvas');
        var w =  document.body.clientWidth,
                h =  document.body.clientHeight;
        var offsetX = canvas.offsetLeft,
                offsetY = canvas.offsetTop;
        var ctx=canvas.getContext('2d');

        var $light = $('.light');
        var $canvas = $('#canvas');
        var $bodyArea = $('.bodyArea');

        var pumpkinArr = [];


        var x,y;

        layer(ctx);
        placePumpkin();

        canvas.addEventListener('touchstart', circle);
        
        $('.allLight').on('touchstart',function (e) {
            e.preventDefault();
            $canvas.hide();
            setTimeout(function(){$canvas.show();},1000)
        });
        
        function placePumpkin() {
            $pumpkin.each(function (key,value) {
                var place = getRandomPlace();
                $(value).css({
                    'left':place.w,
                    'top':place.h
                })
            })
        }
        function getRandomPlace() {
            var obj = {};
            var placeW = $bodyArea.width();
            var placeH = $bodyArea.height();
            var arrW = [];
            var arrH = [];
            $pumpkin.each(function (key,value) {
                arrW.push($(value).width());
                arrH.push($(value).height())
            });
            var maxW = Math.max.apply(null,arrW);
            var maxH = Math.max.apply(null,arrH);

            obj.w =  Math.random()*(placeW - maxW*2) + maxW;
            obj.h =  Math.random()*(placeH - maxH*2) + maxH;

            pumpkinWArr.push(obj.w);
            pumpkinHArr.push(obj.h);
            //[{
            //  l:left,
            //  t:yop,
            //  w:width,
            //  h:height
            // }]
            return obj
        }
        function layer(ctx) {
            canvas.width=w;
            canvas.height=h;
            ctx.fillStyle='transparent';
            ctx.fillRect(0, 0,w,h);
            ctx.fillStyle = 'gray';
            ctx.fillRect(0, 0, w, h);
            ctx.globalCompositeOperation = 'destination-out';
        }
        function circle(e) {
            e.preventDefault();
            var thisX = e.targetTouches[0].clientX,
                    thisY = e.targetTouches[0].clientY;
            if(thisX > x - 10 && thisX < x + 10 && thisY > y - 10 && thisY < y + 10){//在点亮的位置上重新点击，但是半径小一半
                if(thisX){//在南瓜的位置上点击,找到对应的南瓜

                }
            }else{
                layer(ctx);
                x = (e.targetTouches[0].clientX + document.body.scrollLeft || e.pageX) - offsetX || 0;
                y = (e.targetTouches[0].clientY + document.body.scrollTop || e.pageY) - offsetY || 0;
                ctx.beginPath();
                ctx.arc(x, y, 20, 0, Math.PI * 2);
                ctx.fill();
            }
            $light.css({
                left: x +'px',
                top: y  +'px'
            })
        }
        inPumpkinArea()
        function inPumpkinArea(thisX,thisY) {
            $.each(pumpkinWArr,function(key,value){
                if(thisX >= value.l && thisX <= value.l + value.w){
                    return true
                }
            });
            $.each(pumpkinHArr,function(key,value){
                if(thisY >= value.t && thisY <= value.t + value.h){
                    return true
                }
            })
        }


    };

</script>
</body>
</html>